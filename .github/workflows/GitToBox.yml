name: Upload to Box

on:
  workflow_dispatch: # Allows manual or programmatic triggering 
  repository_dispatch:  # Allows triggering from DSN-process_data
    types:
      - trigger-git-to-box  # Custom event type
      
jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout Repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Install dependencies
      - name: Install Dependencies
        run: |
          echo "Installing dependencies..."
          sudo apt-get update
          sudo apt-get install -y libsecret-1-dev

      # Step 3: Install Node.js (for npm)
      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'  # Use LTS version for stability

      # Step 4: Install Box CLI using npm
      - name: Install Box CLI
        run: |
          echo "Installing Box CLI via npm..."
          npm install -g @box/cli
          box --version

      # Step 5: Write `config.json` File
      - name: Write `config.json` File
        env:
          BOX_CONFIG: ${{ secrets.BOX_CONFIG }}
        run: |
          echo "$BOX_CONFIG" > box_config.json

      # Step 6: Authenticate Box CLI
      - name: Authenticate Box CLI
        run: |
          box configure:environments:add box_config.json --name "github-box"
          box configure:environments:set-current "github-box"
          box folders:get 0

      # Step 7: Upload All Files in a Folder to Box
      - name: Upload All Files to Box
        env:
          BOX_FOLDER_ID: "304428997491"  # Box folder DSNdata/ARCHIVE ID
        run: |
          echo "Upload DSNdata/INFLUX files to Box"
          for file in DSNdata/BOX/*; do
            if [ -f "$file" ]; then
              echo "Upload $file to Box..."
              box files:upload "$file" -p "$BOX_FOLDER_ID"
            else
              echo "No files found in DSNdata/BOX."
            fi
          done

      # Step 8: Clean Up `config.json`
      - name: Clean Up
        run: |
          rm -f box_config.json
