name: Upload to Box

on:
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest  # Use `macos-latest` if Homebrew requires it.

    steps:
      # Step 1: Checkout Repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Install Homebrew and Box CLI
      - name: Install Box CLI
        run: |
          echo "Installing Homebrew..."
          NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> /Users/runner/.zprofile
          eval "$(/opt/homebrew/bin/brew shellenv)"
          echo "Installing Box CLI with Homebrew..."
          brew update
          brew install box-cli
          box --version

      # Step 4: Write `config.json` File
      - name: Write `config.json` File
        env:
          BOX_CONFIG: ${{ secrets.BOX_CONFIG }}
        run: |
          echo "$BOX_CONFIG" > box_config.json

      # Step 5: Authenticate Box CLI
      - name: Authenticate Box CLI
        run: |
          box configure:environments:add box_config.json
          box configure:environments:set-current "github-box"

      # Step 6: Upload All Files in a Folder to Box
      - name: Upload All Files to Box
        env:
          BOX_FOLDER_ID: "304428997491"  # Box folder DSNdata/ARCHIVE ID
        run: |
          echo "Upload DSNdata/INFLUX files to Box"
          for file in DSNdata/INFLUX/*; do
            if [ -f "$file" ]; then
              echo "Upload $file to Box..."
              box files:upload "$file" "$BOX_FOLDER_ID"
            else
              echo "No files found in DSNdata/INFLUX to upload."
            fi
          done

      # Step 7: Clean Up `config.json`
      - name: Clean Up
        run: |
          rm -f box_config.json
