name: Update DSN Data

on:
  workflow_dispatch:

jobs:
  update-dsn-data:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          echo "Installing dependencies..."
          sudo apt-get update
          sudo apt-get install -y dos2unix libc-bin curl

      - name: Install Influx CLI
        run: |
          echo "Downloading and installing Influx CLI..."
          curl -sL https://dl.influxdata.com/influxdb/releases/influxdb2-client-2.7.5-linux-amd64.tar.gz -o influxdb2-client.tar.gz
          tar xvzf influxdb2-client.tar.gz
          echo "Listing contents of current directory after extraction:"
          ls -l
          echo "Checking if 'influx' binary exists directly after extraction:"
          if [ -f influx ]; then
            sudo mv influx /usr/local/bin/
          else
            echo "'influx' binary not found directly. Checking for extracted directory..."
            EXTRACTED_DIR=$(find . -type d -name 'influxdb2-client-*')
            if [ -d "$EXTRACTED_DIR" ]; then
              echo "Found extracted directory: $EXTRACTED_DIR"
              sudo mv "$EXTRACTED_DIR/influx" /usr/local/bin/
            else
              echo "No valid directory or binary found. Exiting with error."
              exit 1
            fi
          fi
          echo "Influx CLI installed to /usr/local/bin"
          which influx
          influx version

      - name: Start InfluxDB
        run: |
          echo "Starting InfluxDB..."
          docker run -d \
            --name influxdb \
            -p 8086:8086 \
            -e INFLUXDB_ADMIN_USER=admin \
            -e INFLUXDB_ADMIN_PASSWORD=admin \
            -e INFLUXDB_DB=dsn \
            influxdb:2.0

      - name: Run InfluxDB Write in Docker
        env:
          INFLUX_TOKEN: ${{ secrets.INFLUX_TOKEN }}
        run: |
          echo "Running influx write..."
          echo 'temperature,location=office value=22.5 1673961600000000000' > /tmp/data.lp
          influx write \
            --url https://us-east-1-1.aws.cloud2.influxdata.com \
            --org DSN \
            --bucket TEST \
            --token $INFLUX_TOKEN \
            --file /tmp/data.lp
          echo "Data written successfully."
