name: Install and Run Influx CLI

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  install-and-write:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Homebrew
        run: |
          echo "Installing Homebrew..."
          sudo apt-get update
          sudo apt-get install -y build-essential curl dos2unix
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" >/dev/null 2>&1
          echo 'eval $(/home/linuxbrew/.linuxbrew/bin/brew shellenv)' >>~/.profile
          echo 'eval $(/home/linuxbrew/.linuxbrew/bin/brew shellenv)' >>~/.bashrc
          source ~/.profile
          brew --version

      - name: Install Influx CLI
        run: |
          echo "Installing Influx CLI..."
          source ~/.profile
          brew update
          brew install influxdb-cli
          influx version

      - name: Set Environment Variables
        run: |
          export LC_ALL=C.UTF-8
          export LANG=C.UTF-8

      - name: Hex Dump of Problematic Line
        run: |
          echo "Hex dump of line 22:"
          sed -n '22p' DSNdata/INFLUX/test.csv | hexdump -C

      - name: Output Line 22
        run: |
          echo "Content of line 22:"
          sed -n '22p' DSNdata/INFLUX/test.csv

      - name: Write Minimal Example to InfluxDB
        env:
          INFLUX_TOKEN: ${{ secrets.INFLUX_TOKEN }}
        run: |
          echo "timestamp,measurement,value" > /tmp/minimal.csv
          echo "2023-01-17T10:00:00Z,office,22.5" >> /tmp/minimal.csv
          source ~/.profile
          influx write \
            --url https://us-east-1-1.aws.cloud2.influxdata.com \
            --org DSN \
            --bucket DSNdata \
            --token $INFLUX_TOKEN \
            --file /tmp/minimal.csv \
            --format csv \
            --skipRowOnError \
            --errors-file /tmp/ERRORS
          echo "Minimal Test Error File Contents:"
          cat /tmp/ERRORS || true

      - name: Write Original Data to InfluxDB
        env:
          INFLUX_TOKEN: ${{ secrets.INFLUX_TOKEN }}
        run: |
          cp DSNdata/INFLUX/test.csv /tmp/test.csv
          source ~/.profile
          influx write \
            --url https://us-east-1-1.aws.cloud2.influxdata.com \
            --org DSN \
            --bucket DSNdata \
            --token $INFLUX_TOKEN \
            --file /tmp/test.csv \
            --format csv \
            --skipRowOnError \
            --errors-file /tmp/ERRORS
          echo "Original Test Error File Contents:"
          cat /tmp/ERRORS || true
